# 数据持久化

你或许在之前的小节中已经发现，每当我们启动一个新的容器，我们就会丢失之前的 todo list 。这是因为容器中的数据文件都是临时的，一旦容器被摧毁数据也会消失，在本节中我们将会学习如何持久化我们的数据。

## 容器文件系统

当容器运行时，它将镜像中的各个层用作其文件系统。每个容器也有自己的“暂存空间”来创建/更新/删除文件。在另一个容器中不会看到任何更改，即使它们使用相同的图像。

## 验证练习

下面我们将通过以下几个步骤来进行验证，我们将会启动两个相同的容器并且在每个容器中创建一个文件。你将会发现容器的文件系统是相互独立的。

1. 启动一个 `ubuntu` 容器并创建一个 `/data.txt` 的文件，在文件中写入 1 - 10000 的随机数。  
   `docker run -d ubuntu bash -c "shuf -i 1-10000 -n 1 -o /data.txt && tail -f /dev/null"`  
   这条命令会以后台的方式运行一个 unbuntu 容器，并在启东时通过 bash 执行两条命令(`&&` 就是命令的分隔符)。`shuf -i 1-10000 -n 1 -o /data.txt` 随机生成一个 1 - 10000 以内的随机数并写入 `/data.txt` 文件中，`tail -f /dev/null` 则会保持容器运行。(关于如何保持容器运行我们会在后面详细讲解)
2. 找到我们刚才启动的 ubuntu 容器 ID，通过以下命令进入容器中  
   `docker exec -it <CONTAINER-ID> bash`  
   现在我们已经进入到了刚才启动的 ubuntu 容器中，通过以下命令查看 `/data.txt` 中的随机数字  
   `cat /data.txt`

   > 小技巧: 我们可以通过这条命令直接查看容器的文件内容，而不需要进入到容器中  
   > `docker exec <CONTAINER-ID> cat /data.txt`

   > 另一个小技巧，容器 ID 不用完全复制，只要能让 Docker 分别是哪一个容器即可

3. 现在让我们在另一个容器中验证文件是否存在
   `docker run -it ubuntu ls /`  
   我们会发现目录下没有 `/data.txt` 文件存在，这是因为容器的临时文件系统是相互独立的。

4. 现在让我们通过 `docker rm -f <container-id>` 命令删除掉刚才运行的 ubuntu 容器。

## 容器卷

通过镜像生成的容器实例，本身也是一个文件，可以叫做容器文件。也就是说，生成容器会存在两个文件，镜像文件和容器文件。停止(stop)容器并不会删除容器文件，而销毁(rm)容器则会删除掉容器文件。  
那我们要怎样保留（持久化）我们的数据文件呢，办法就是利用卷(Volumes)。卷可以将特定的目录连接到我们的主机文件系统中，如果挂载了容器中的目录，则主机上也会看到该目录中的更改。如果我们在容器重新启动时挂载相同的目录，我们会看到相同的文件。
卷的类型主要有两种，我们先从命名卷（named volumes）开始。

## 持久化 todo 列表数据

默认情况下我们的 todo 应用会使用 SQLite 数据库存储在**容器文件**的 `/etc/todos/todo.db` 目录中。接下来，我们使用**命名卷**来持久化 `todo.db` 文件。  
你可将命名卷视为一个存储桶，当我们生成一个新的命名卷时 Docker 会自动帮我们在磁盘上创建一个目录，我们的命名卷就对应这个目录，我们只需要记住卷的名称就可以了。

1. 使用 `docker volume create` 创建卷  
   `docker volume create todo-db`
2. 销毁之前正在运行的应用容器(docker rm -f <id>)，因为它没有使用持久卷。
3. 启动一个新的 todo 应用容器，添加 `-v` 标志挂载持久卷  
   `docker run -dp 3000:3000 -v todo-db:/etc/todos gettting-started`
4. 容器启动后，打开应用程序并添加一些项目到您的待办事项列表中。  
   ![image](https://docs.docker.com/get-started/images/items-added.png)
5. 停止并移除 todo 应用程序的容器。使用仪表板或`docker ps`获取 ID，然后`docker rm -f <id>`将其删除。
6. 使用与上面相同的命令启动一个新容器。
7. 打开应用程序。您应该会看到您的项目仍在您的列表中！
8. 完成检查列表后，记得移除容器。

现在，我们已经成功持久化了我们容器的数据!

如果你想知道命名卷的位于磁盘上的实际存储路径，可以使用 `docker volume inspect` 命令。

```
docker volume inspect todo-db
```

**Mountpoint** 就是数据存储在磁盘上的实际位置。请注意，在大多数机器上，您需要具有 root 访问权限才能从主机访问此目录。
